<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimator Pro - Modern Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --gray-900: #1e293b;
            --gray-800: #334155;
            --gray-700: #475569;
            --gray-600: #64748b;
            --gray-500: #94a3b8;
            --gray-400: #cbd5e1;
            --gray-300: #e2e8f0;
            --gray-200: #f1f5f9;
            --gray-100: #f8fafc;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-dark: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        body.dark-mode {
            --gray-100: #1e293b;
            --gray-200: #334155;
            --gray-300: #475569;
            --gray-400: #64748b;
            --gray-500: #94a3b8;
            --gray-600: #cbd5e1;
            --gray-700: #e2e8f0;
            --gray-800: #f1f5f9;
            --gray-900: #f8fafc;
            --dark: #ffffff;
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--gradient-dark);
            padding: 2rem;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--gradient);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .logo-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .logo-text span {
            display: block;
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.8;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: var(--gray-100);
        }

        .header {
            background: white;
            padding: 1.5rem 2.5rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .sync-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1.25rem;
            background: var(--gray-100);
            border-radius: 100px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            transition: all 0.3s ease;
        }
        
        .sync-badge.syncing {
            background: #fef3c7;
            color: #92400e;
        }

        .sync-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }

        .content {
            padding: 2.5rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* Material Selection Cards */
        .material-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .material-card {
            position: relative;
            padding: 1rem;
            border: 3px solid var(--gray-200);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
            overflow: hidden;
        }
        
        .material-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .material-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .material-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        
        .material-card.selected::before {
            opacity: 1;
        }

        .material-name {
            position: relative;
            z-index: 1;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .material-price {
            position: relative;
            z-index: 1;
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .material-card.selected .material-price {
            opacity: 0.9;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.2);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .btn:hover::before {
            transform: translateX(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--gray-600);
            box-shadow: none;
        }
        
        .btn-ghost:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        /* Summary Cards */
        .summary-card {
            background: var(--gradient);
            color: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 5s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .summary-item {
            position: relative;
            z-index: 1;
        }

        .summary-label {
            font-size: 0.875rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
        }
        
        /* Tables */
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .modern-table thead {
            background: var(--gray-100);
        }

        .modern-table th {
            padding: 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--gray-200);
        }

        .modern-table td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .modern-table tbody tr {
            transition: all 0.2s ease;
        }
        
        .modern-table tbody tr:hover {
            background: var(--gray-50);
            transform: scale(1.01);
        }

        /* Line Items */
        .line-item-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-100);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        
        .line-item-row input, .line-item-row select {
            margin: 0;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .category-divider {
            font-weight: 700;
            color: var(--primary);
            margin: 2rem 0 1rem;
            padding: 0.75rem;
            background: linear-gradient(90deg, var(--primary-light) 0%, transparent 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        body.dark-mode .modal {
            background: rgba(0, 0, 0, 0.6);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-dialog {
            background: var(--gray-100);
            color: var(--gray-900);
            border-radius: 24px;
            border: 1px solid var(--gray-200);
            padding: 2.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        body.dark-mode .modal-dialog {
            background: var(--gray-200);
            color: var(--gray-800);
            border-color: var(--gray-300);
        }

        /* Dark Mode Adjustments */
        body.dark-mode .header {
            background: var(--gray-200);
        }

        body.dark-mode .card,
        body.dark-mode .material-card,
        body.dark-mode .toast,
        body.dark-mode .modern-table {
            background: var(--gray-200);
            color: var(--gray-900);
            border-color: var(--gray-300);
        }

        body.dark-mode .material-card.selected {
            background: var(--primary);
            color: white;
        }

        body.dark-mode .modern-table thead {
            background: var(--gray-100);
        }

        body.dark-mode .modern-table tbody tr:hover {
            background: var(--gray-300);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-select {
            background: var(--gray-100);
            color: var(--gray-900);
            border-color: var(--gray-300);
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--dark);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--gray-100);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gray-600);
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--gray-200);
            color: var(--dark);
            transform: rotate(90deg);
        }
        
        /* Toast Notifications */
        #toastContainer {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            border: 2px solid transparent;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.9); }
        }

        .toast.success {
            border-color: var(--success);
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        .toast.warning {
            border-color: var(--warning);
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        .toast.error {
            border-color: var(--danger);
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        /* Update Badge */
        .update-badge {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid var(--success);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .update-list {
            list-style: none;
            margin-top: 1rem;
        }
        
        .update-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: var(--gray-700);
        }
        
        .update-icon {
            color: var(--success);
            font-size: 1.25rem;
        }

        /* Calculator */
        .calculator-dialog {
            max-width: 480px;
            background: var(--gray-100);
            color: var(--gray-900);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-xl);
        }

        body.dark-mode .calculator-dialog {
            background: var(--gray-200);
            color: var(--gray-800);
        }
        .calculator-display {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            text-align: right;
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            min-height: 60px;
            word-wrap: break-word;
            color: var(--dark);
            border: 2px solid var(--gray-300);
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .calculator-grid button {
            padding: 1.25rem;
            font-size: 1.25rem;
            border-radius: 12px;
            background: var(--gray-200);
            border: none;
        }
        .calculator-grid button:hover {
            background: var(--gray-300);
        }
        .calculator-grid .btn-secondary {
            background-color: var(--gray-300);
            color: var(--dark);
        }
        .calculator-grid .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .mode-switch {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .mode-btn {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--gray-300);
            background: var(--white);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
        }
        .mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .unit-converter {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
        }

        /* Mobile Menu Toggle */
        #basicTools .form-group {
            margin-bottom: 0.75rem;
        }
        #engineeringBtns {
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 200;
            width: 48px;
            height: 48px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
        }
        
        .space-y-3 > * + * {
            margin-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
             .grid-2, .grid-3, .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .header {
                padding-left: 5rem;
            }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            .header-actions {
                gap: 0.5rem;
            }
            .sync-badge span {
                display: none;
            }
            .summary-value {
                font-size: 2rem;
            }
            .line-item-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        @media (max-width: 640px) {
            .content {
                padding: 1rem;
            }
            .card, .summary-card {
                padding: 1.5rem;
            }
        }

        /* Print Styles */
        @media print {
            .sidebar, .header-actions, .menu-toggle, .btn, #toastContainer, .modal {
                display: none !important;
            }
            .main-content {
                margin-left: 0;
            }
            body {
                background: white;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
            .tab-content {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" id="menuToggle">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="logo-container">
            <div class="logo">CE</div>
            <div class="logo-text">
                Construction Pro
                <span>Estimator Suite 2025</span>
            </div>
        </div>

        <button class="nav-item active" data-tab="dashboard">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            Dashboard
        </button>
        <button class="nav-item" data-tab="estimator">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
            Quick Estimator
        </button>
        <button class="nav-item" data-tab="detailed">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            Detailed Bidding
        </button>
        <button class="nav-item" data-tab="projects">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
            Projects
        </button>
        <button class="nav-item" data-tab="materials">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10a2 2 0 002 2h12a2 2 0 002-2V7M4 7l8-4 8 4M4 7l8 4m0 0l8-4m-8 4v10"></path></svg>
            Materials Database
        </button>
        <button class="nav-item" data-tab="settings">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="header">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
            <div class="header-actions">
                <button class="btn btn-ghost" id="calculatorBtn" aria-label="Open Calculator">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                </button>
                <div class="sync-badge" id="syncStatus">
                    <div class="sync-dot"></div>
                    <span>Database synced</span>
                </div>
                <button class="btn btn-ghost" id="themeToggle" aria-label="Toggle Theme">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                </button>
                <button class="btn btn-primary" id="newProjectBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Project
                </button>
            </div>
        </header>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="grid-4" style="margin-bottom: 2rem;">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Total Projects</h3><svg width="24" height="24" fill="none" stroke="var(--primary)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg></div>
                        <p id="totalProjects" style="font-size: 2.5rem; font-weight: 800; color: var(--primary);">0</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Total Value</h3><svg width="24" height="24" fill="none" stroke="var(--success)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                        <p id="totalValue" style="font-size: 2.5rem; font-weight: 800; color: var(--success);">$0</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Under Review</h3><svg width="24" height="24" fill="none" stroke="var(--warning)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div>
                        <p id="reviewCount" style="font-size: 2.5rem; font-weight: 800; color: var(--warning);">0</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Win Rate</h3><svg width="24" height="24" fill="none" stroke="var(--secondary)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                        <p id="winRate" style="font-size: 2.5rem; font-weight: 800; color: var(--secondary);">0%</p>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1.5rem;">Recent Projects</h3>
                        <div id="recentProjectsList" class="space-y-3"></div>
                        <button class="btn btn-secondary" id="viewAllProjectsBtn" style="margin-top:1rem;">View All</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1.5rem;">Material Price Trends</h3>
                        <canvas id="priceChart" style="max-height: 200px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Estimator Tab -->
            <div id="estimatorTab" class="tab-content">
                <div class="grid-2">
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 2rem;">Project Information</h3>
                        <form id="estimatorForm">
                            <div class="form-group"><label class="form-label">Project Name</label><input type="text" class="form-input" id="projectName" placeholder="Enter project name" required></div>
                            <div class="grid-2" style="gap: 1rem;">
                                <div class="form-group"><label class="form-label">Project Type</label><select class="form-select" id="projectType" required><option value="">Select type</option><option value="residential">Residential</option><option value="commercial">Commercial</option><option value="industrial">Industrial</option><option value="renovation">Renovation</option></select></div>
                                <div class="form-group"><label class="form-label">Square Footage</label><input type="number" class="form-input" id="sqft" placeholder="Enter sqft" required></div>
                            </div>
                            <div class="grid-2" style="gap: 1rem;">
                                <div class="form-group"><label class="form-label">Number of Floors</label><input type="number" class="form-input" id="floors" value="1" min="1" required></div>
                                <div class="form-group"><label class="form-label">Labor Multiplier</label><input type="number" class="form-input" id="laborCost" value="1.5" step="0.1" min="1"></div>
                            </div>
                            <div class="form-group"><label class="form-label">Foundation Type</label><div class="material-grid"><div class="material-card" data-foundation="slab"><div class="material-name">Slab</div><div class="material-price">$4.50/sqft</div></div><div class="material-card" data-foundation="crawl"><div class="material-name">Crawl Space</div><div class="material-price">$7.00/sqft</div></div><div class="material-card" data-foundation="basement"><div class="material-name">Basement</div><div class="material-price">$12.00/sqft</div></div></div></div>
                            <div class="form-group"><label class="form-label">Framing Material</label><div class="material-grid"><div class="material-card" data-framing="wood"><div class="material-name">Wood</div><div class="material-price">$15/sqft</div></div><div class="material-card" data-framing="steel"><div class="material-name">Steel</div><div class="material-price">$20/sqft</div></div><div class="material-card" data-framing="concrete"><div class="material-name">Concrete</div><div class="material-price">$25/sqft</div></div></div></div>
                            <div class="form-group"><label class="form-label">Exterior Finish</label><div class="material-grid"><div class="material-card" data-exterior="vinyl"><div class="material-name">Vinyl</div><div class="material-price">$3/sqft</div></div><div class="material-card" data-exterior="brick"><div class="material-name">Brick</div><div class="material-price">$8/sqft</div></div><div class="material-card" data-exterior="stucco"><div class="material-name">Stucco</div><div class="material-price">$6/sqft</div></div><div class="material-card" data-exterior="stone"><div class="material-name">Stone</div><div class="material-price">$15/sqft</div></div></div></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>Calculate Estimate</button>
                        </form>
                    </div>
                    <div>
                        <div class="card" id="breakdownCard" style="display: none;">
                            <h3 class="card-title" style="margin-bottom: 2rem;">Cost Breakdown</h3>
                            <div id="breakdownContent"></div>
                        </div>
                        <div class="summary-card" id="estimateSummary" style="display: none; margin-top: 2rem;">
                            <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Estimate Summary</h2>
                            <div class="summary-grid">
                                <div class="summary-item"><div class="summary-label">Materials</div><div class="summary-value" id="materialCost">$0</div></div>
                                <div class="summary-item"><div class="summary-label">Labor</div><div class="summary-value" id="laborCostDisplay">$0</div></div>
                                <div class="summary-item"><div class="summary-label">Total</div><div class="summary-value" id="totalCost">$0</div></div>
                            </div>
                            <button class="btn btn-secondary" id="saveProjectBtn" style="margin-top: 2rem;">Save Project</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Bidding Tab -->
            <div id="detailedTab" class="tab-content">
                 <div class="card">
                    <h3 class="card-title" style="margin-bottom: 2rem;">Bid Information</h3>
                    <form id="detailedBidForm">
                        <div class="grid-2" style="gap: 1rem;">
                            <div class="form-group"><label class="form-label">Project Name</label><input type="text" class="form-input" id="bidProjectName" placeholder="Enter project name" required></div>
                            <div class="form-group"><label class="form-label">Client Name</label><input type="text" class="form-input" id="clientName" placeholder="Enter client name" required></div>
                            <div class="form-group"><label class="form-label">Bid Date</label><input type="date" class="form-input" id="bidDate" required></div>
                            <div class="form-group"><label class="form-label">Completion Timeline (Days)</label><input type="number" class="form-input" id="completionDays" placeholder="Enter days" required></div>
                        </div>
                    </form>
                </div>
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header"><h3 class="card-title">Line Items</h3><button class="btn btn-secondary" id="addLineItemBtn">+ Add Item</button></div>
                    <div id="lineItems" style="margin-top: 1.5rem;"></div>
                </div>
                <div class="grid-3" style="margin-top: 2rem;">
                    <div class="card"><h4 style="margin-bottom: 1rem;">Overhead</h4><input type="number" class="form-input" id="overhead" value="10" min="0" step="0.1"><span style="color: var(--gray-600); font-size: 0.875rem;">%</span></div>
                    <div class="card"><h4 style="margin-bottom: 1rem;">Profit Margin</h4><input type="number" class="form-input" id="profit" value="15" min="0" step="0.1"><span style="color: var(--gray-600); font-size: 0.875rem;">%</span></div>
                    <div class="card"><h4 style="margin-bottom: 1rem;">Contingency</h4><input type="number" class="form-input" id="contingency" value="5" min="0" step="0.1"><span style="color: var(--gray-600); font-size: 0.875rem;">%</span></div>
                </div>
                <div class="summary-card" style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Bid Summary</h2>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="summary-label">Subtotal</div><div class="summary-value" id="bidSubtotal">$0</div></div>
                        <div class="summary-item"><div class="summary-label">Markup</div><div class="summary-value" id="bidMarkup">$0</div></div>
                        <div class="summary-item"><div class="summary-label">Contingency</div><div class="summary-value" id="bidContingency">$0</div></div>
                        <div class="summary-item"><div class="summary-label">Total Bid</div><div class="summary-value" id="bidTotal">$0</div></div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-primary" id="exportPdfBtn">Export PDF</button>
                        <button class="btn btn-primary" id="exportXlsxBtn">Export Excel</button>
                        <button class="btn btn-primary" id="exportCsvBtn">Export CSV</button>
                        <button class="btn btn-success" id="saveBidBtn" style="margin-left: auto;">Save Bid</button>
                    </div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Saved Projects</h3>
                        <input type="search" class="form-input" id="projectSearch" placeholder="Search projects..." style="max-width: 200px;">
                        <button class="btn btn-secondary" id="exportProjectsBtn">Export</button>
                        <button class="btn btn-secondary" id="importProjectsBtn">Import</button>
                        <input type="file" id="importProjectsInput" style="display:none">
                    </div>
                    <div id="projectsList" style="margin-top: 2rem;"></div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div id="materialsTab" class="tab-content">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Material Price Database</h3><span style="color: var(--gray-600);">Last updated: <span id="lastUpdate">Today</span></span></div>
                    <table class="modern-table" style="margin-top: 2rem;">
                        <thead><tr><th>Material</th><th>Category</th><th>Price</th><th>Unit</th><th>Trend</th></tr></thead>
                        <tbody id="materialsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 2rem;">Application Settings</h3>
                    <div class="grid-2" style="gap: 2rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem;">Database Updates</h4>
                            <div class="form-group"><label class="form-label">Automatic Updates</label><select class="form-select" id="autoUpdate"><option value="enabled">Enabled</option><option value="disabled">Disabled</option></select></div>
                            <div class="form-group"><label class="form-label">Update Frequency</label><select class="form-select" id="updateFrequency"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                            <button class="btn btn-primary" id="checkUpdatesBtn">Check for Updates</button>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 1rem;">Preferences</h4>
                            <div class="form-group"><label class="form-label">Currency</label><select class="form-select"><option>USD ($)</option><option>EUR (€)</option><option>GBP (£)</option></select></div>
                            <div class="form-group"><label class="form-label">Default Tax Rate (%)</label><input type="number" class="form-input" value="8.5" step="0.1"></div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top:2rem;">
                    <h3 class="card-title" style="margin-bottom:1.5rem;">Company Information</h3>
                    <div class="grid-2" style="gap:1rem;">
                        <div class="form-group"><label class="form-label">Company Name</label><input type="text" class="form-input" id="companyName"></div>
                        <div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="companyAddress"></div>
                        <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="companyPhone"></div>
                        <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="companyEmail"></div>
                    </div>
                    <button class="btn btn-primary" id="saveCompanyBtn" style="margin-top:1rem;">Save Company Info</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal" id="updateModal">
        <div class="modal-dialog">
            <div class="modal-header"><h2 class="modal-title">Database Update Available</h2><button class="modal-close" id="closeUpdateModal">&times;</button></div>
            <div class="update-badge">
                <h3 style="margin-bottom: 1rem;">Material Price Updates - July 2025</h3>
                <ul class="update-list">
                    <li class="update-item"><span class="update-icon">✓</span><span>Lumber prices decreased by 5%</span></li>
                    <li class="update-item"><span class="update-icon">✓</span><span>Steel prices increased by 3%</span></li>
                    <li class="update-item"><span class="update-icon">✓</span><span>Labor rates updated for your region</span></li>
                    <li class="update-item"><span class="update-icon">✓</span><span>15 new materials added to database</span></li>
                </ul>
            </div>
            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Keep your estimates accurate with the latest market prices.</p>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" id="applyUpdateBtn">Apply Update</button>
                <button class="btn btn-secondary" id="laterBtn">Remind Me Later</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="calculatorModal">
        <div class="modal-dialog calculator-dialog">
            <div class="modal-header"><h2 class="modal-title">Unit Calculator</h2><button class="modal-close" id="closeCalculatorModal">&times;</button></div>
            <div class="calculator-display" id="calculatorDisplay">0</div>
            <div class="mode-switch">
                <button id="modeBasic" class="mode-btn active" data-mode="basic">Basic</button>
                <button id="modeEngineering" class="mode-btn" data-mode="engineering">Engineering</button>
            </div>
            <div class="calculator-grid" id="calculatorGrid">
                <button class="btn btn-secondary" data-value="clear">C</button>
                <button class="btn btn-secondary" data-value="backspace">⌫</button>
                <button class="btn btn-secondary" data-value="%">%</button>
                <button class="btn btn-primary" data-value="/">&divide;</button>
                <button class="btn" data-value="7">7</button>
                <button class="btn" data-value="8">8</button>
                <button class="btn" data-value="9">9</button>
                <button class="btn btn-primary" data-value="*">&times;</button>
                <button class="btn" data-value="4">4</button>
                <button class="btn" data-value="5">5</button>
                <button class="btn" data-value="6">6</button>
                <button class="btn btn-primary" data-value="-">-</button>
                <button class="btn" data-value="1">1</button>
                <button class="btn" data-value="2">2</button>
                <button class="btn" data-value="3">3</button>
                <button class="btn btn-primary" data-value="+">+</button>
                <button class="btn" data-value="0" style="grid-column: span 2;">0</button>
                <button class="btn" data-value=".">.</button>
                <button class="btn btn-primary" data-value="=">=</button>
            </div>
            <div id="engineeringBtns" class="calculator-grid" style="display:none; margin-top:1rem;">
                <button class="btn" data-value="sin">sin</button>
                <button class="btn" data-value="cos">cos</button>
                <button class="btn" data-value="tan">tan</button>
                <button class="btn" data-value="sqrt">√</button>
            </div>
            <div class="unit-converter">
                <select id="unitFrom" class="form-select"><option value="ft">Feet</option><option value="in">Inches</option><option value="sqft">Sq. Ft.</option><option value="sqyd">Sq. Yd.</option></select>
                <button class="btn btn-secondary" id="convertUnitBtn">&rarr;</button>
                <select id="unitTo" class="form-select"><option value="in">Inches</option><option value="ft">Feet</option><option value="sqyd">Sq. Yd.</option><option value="sqft">Sq. Ft.</option></select>
            </div>
            <div id="basicTools" style="margin-top:1rem; display:none;">
                <h3>Simple Takeoff</h3>
                <div class="form-group">
                    <label class="form-label">Shape</label>
                    <select id="shapeSelect" class="form-select">
                        <option value="rectangle">Rectangle</option>
                        <option value="circle">Circle</option>
                        <option value="triangle">Triangle</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" id="dim1" class="form-input" placeholder="Length">
                </div>
                <div class="form-group" id="dim2Group">
                    <input type="number" id="dim2" class="form-input" placeholder="Width">
                </div>
                <button class="btn btn-primary" id="calcAreaBtn">Calculate Area</button>
                <p id="takeoffResult" style="margin-top:0.5rem;"></p>
                <div class="form-group" style="margin-top:1rem;">
                    <label class="form-label">Upload Plan</label>
                    <input type="file" id="planUpload" class="form-input">
                </div>
                <img id="planPreview" style="max-width:100%; margin-top:1rem; display:none;"/>
            </div>
            <button class="btn btn-success" id="useValueBtn" style="width: 100%; margin-top: 1.5rem;">Use Value</button>
        </div>
    </div>
    <div class="modal" id="newProjectModal">
        <div class="modal-dialog">
            <div class="modal-header"><h2 class="modal-title">Select Estimator Type</h2><button class="modal-close" id="closeNewProjectModal">&times;</button></div>
            <div style="display:flex; gap:1rem; justify-content:center; margin-top:1rem;">
                <button class="btn btn-primary" id="startQuickBtn">Quick Estimator</button>
                <button class="btn btn-secondary" id="startDetailedBtn">Detailed Bidding</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
    (function() {
        'use strict';

        // --- STATE MANAGEMENT ---
        const state = {
            currentTab: 'dashboard',
            materialPrices: {},
            savedProjects: [],
            companyInfo: { name: '', address: '', phone: '', email: '' },
            currentEstimate: null,
            editingProjectId: null,
            lineItemId: 0,
            lastFocusedInput: null,
            calcMode: "basic",
            calculator: {
                displayValue: '0',
                firstOperand: null,
                waitingForSecondOperand: false,
                operator: null
            },
            lineItemCategories: {}
        };

        async function loadDatabase() {
            try {
                const res = await fetch('database.json');
                const data = await res.json();
                state.materialPrices = data.materialPrices || {};
                state.lineItemCategories = data.lineItemCategories || {};
            } catch (err) {
                console.error('Error loading database:', err);
            }
        }

        // --- INITIALIZATION ---
        function init() {
            loadSavedData();
            setupEventListeners();
            setupNavigation();
            populateMaterialsTable();
            loadProjects();
            updateDashboard();
            initCharts();
            checkForUpdatesOnLoad();
            
            const bidDateInput = document.getElementById('bidDate');
            if (bidDateInput) {
                bidDateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('constructionProjects');
                state.savedProjects = savedData ? JSON.parse(savedData) : [];
                state.savedProjects.forEach(p => { if (!p.status) p.status = 'review'; });
                const companyData = localStorage.getItem('companyInfo');
                state.companyInfo = companyData ? JSON.parse(companyData) : state.companyInfo;
                document.getElementById('companyName').value = state.companyInfo.name || '';
                document.getElementById('companyAddress').value = state.companyInfo.address || '';
                document.getElementById('companyPhone').value = state.companyInfo.phone || '';
                document.getElementById('companyEmail').value = state.companyInfo.email || '';
                const theme = localStorage.getItem('darkMode');
                if (theme === 'on') document.body.classList.add('dark-mode');
            } catch (e) {
                console.error('Error loading saved data:', e);
                state.savedProjects = [];
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('menuToggle')?.addEventListener('click', toggleSidebar);
            document.getElementById('estimatorForm')?.addEventListener('submit', handleEstimatorSubmit);
            document.querySelectorAll('.material-card').forEach(card => card.addEventListener('click', handleMaterialSelection));
            document.getElementById('saveProjectBtn')?.addEventListener('click', saveProject);
            document.getElementById('addLineItemBtn')?.addEventListener('click', () => addLineItem());
            
            // Export Buttons
            document.getElementById('exportPdfBtn')?.addEventListener('click', exportAsPdf);
            document.getElementById('exportXlsxBtn')?.addEventListener('click', exportAsXlsx);
            document.getElementById('exportCsvBtn')?.addEventListener('click', exportAsCsv);

            document.getElementById('saveBidBtn')?.addEventListener('click', saveBid);
            document.getElementById('saveCompanyBtn')?.addEventListener('click', saveCompanyInfo);
            document.getElementById('checkUpdatesBtn')?.addEventListener('click', checkForUpdates);
            document.getElementById('applyUpdateBtn')?.addEventListener('click', applyUpdate);
            document.getElementById('laterBtn')?.addEventListener('click', () => closeModal('updateModal'));
            document.getElementById('newProjectBtn')?.addEventListener('click', () => openModal('newProjectModal'));
            document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
            document.getElementById('projectSearch')?.addEventListener('input', (e) => loadProjects(e.target.value));

            document.getElementById('exportProjectsBtn')?.addEventListener('click', exportProjects);
            document.getElementById('importProjectsBtn')?.addEventListener('click', () => document.getElementById('importProjectsInput').click());
            document.getElementById('importProjectsInput')?.addEventListener('change', importProjects);

            document.getElementById('startQuickBtn')?.addEventListener('click', () => { closeModal('newProjectModal'); switchTab('estimator'); });
            document.getElementById('startDetailedBtn')?.addEventListener('click', () => { closeModal('newProjectModal'); switchTab('detailed'); });
            document.getElementById('closeNewProjectModal')?.addEventListener('click', () => closeModal('newProjectModal'));
            
            // Modals
            document.getElementById('closeUpdateModal')?.addEventListener('click', () => closeModal('updateModal'));
            document.getElementById('calculatorBtn')?.addEventListener('click', () => openModal('calculatorModal'));
            document.getElementById('closeCalculatorModal')?.addEventListener('click', () => closeModal('calculatorModal'));

            ['overhead', 'profit', 'contingency'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateBidTotal);
            });
            
            const lineItemsContainer = document.getElementById('lineItems');
            lineItemsContainer.addEventListener('change', (e) => {
                const target = e.target;
                const row = target.closest('.line-item-row');
                if (!row) return;

                if (target.dataset.field === 'category') {
                    updateItemSelectionOptions(row);
                } else if (target.dataset.field === 'description') {
                    updateLineItemFromSelection(target);
                }
            });
            lineItemsContainer.addEventListener('input', (e) => {
                const target = e.target;
                const row = target.closest('.line-item-row');
                if (!row) return;

                if (target.dataset.field === 'quantity' || target.dataset.field === 'rate' || target.dataset.field === 'unit') {
                    updateLineItemTotal(row);
                }
            });
            lineItemsContainer.addEventListener('click', (e) => {
                const removeButton = e.target.closest('.remove-line-item');
                if (removeButton) {
                    removeLineItem(removeButton.closest('.line-item-row'));
                }
            });
            lineItemsContainer.addEventListener('focusin', (e) => {
                if (e.target.matches('[data-field="quantity"], [data-field="rate"]')) {
                    state.lastFocusedInput = e.target;
                }
            });
            
            // Calculator
            document.getElementById('calculatorGrid')?.addEventListener('click', handleCalculatorClick);
            document.getElementById('convertUnitBtn')?.addEventListener('click', handleUnitConversion);
            document.getElementById('useValueBtn')?.addEventListener('click', useCalculatorValue);
            document.getElementById('modeBasic')?.addEventListener('click', () => updateCalcMode('basic'));
            document.getElementById('modeEngineering')?.addEventListener('click', () => updateCalcMode('engineering'));
            document.getElementById("shapeSelect")?.addEventListener("change", updateShapeInputs);
            document.getElementById("calcAreaBtn")?.addEventListener("click", calculateArea);
            document.getElementById("planUpload")?.addEventListener("change", handlePlanUpload);
            document.getElementById('viewAllProjectsBtn')?.addEventListener('click', () => switchTab('projects'));
            updateCalcMode(state.calcMode);
        }

        // --- NAVIGATION & UI ---
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${tabId}Tab`)?.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`)?.classList.add('active');

            const pageTitle = document.querySelector(`.nav-item[data-tab="${tabId}"]`)?.innerText || 'Dashboard';
            document.getElementById('pageTitle').textContent = pageTitle;
            
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar')?.classList.toggle('open');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'on' : 'off');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✓' : type === 'error' ? '!' : '?';
            
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
        
        function openModal(modalId) {
            document.getElementById(modalId)?.classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.remove('active');
        }

        // --- QUICK ESTIMATOR ---
        function handleMaterialSelection(e) {
            const card = e.currentTarget;
            card.parentElement.querySelectorAll('.material-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
        }

        function handleEstimatorSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const sqft = parseFloat(form.querySelector('#sqft').value);
            const floors = parseFloat(form.querySelector('#floors').value);
            const laborMultiplier = parseFloat(form.querySelector('#laborCost').value);

            const selected = {
                foundation: document.querySelector('[data-foundation].selected')?.dataset.foundation,
                framing: document.querySelector('[data-framing].selected')?.dataset.framing,
                exterior: document.querySelector('[data-exterior].selected')?.dataset.exterior,
            };

            if (!selected.foundation || !selected.framing || !selected.exterior) {
                showToast('Please select all material types.', 'error');
                return;
            }

            const costs = {
                foundation: state.materialPrices.foundation[selected.foundation] * sqft,
                framing: state.materialPrices.framing[selected.framing] * sqft * floors,
                exterior: state.materialPrices.exterior[selected.exterior] * sqft * floors * 0.8,
            };

            const materialTotal = Object.values(costs).reduce((sum, cost) => sum + cost, 0);
            const laborTotal = materialTotal * laborMultiplier;
            const total = materialTotal + laborTotal;

            state.currentEstimate = {
                id: state.editingProjectId || state.currentEstimate?.id || Date.now(),
                estimateType: 'quick',
                name: form.querySelector('#projectName').value,
                type: form.querySelector('#projectType').value,
                sqft, floors, laborMultiplier,
                selected,
                costs,
                materialTotal, laborTotal, total,
                date: new Date().toISOString(),
                status: state.currentEstimate?.status || 'review'
            };

            displayEstimate(state.currentEstimate);
        }

        function displayEstimate(estimate) {
            document.getElementById('materialCost').textContent = formatCurrency(estimate.materialTotal);
            document.getElementById('laborCostDisplay').textContent = formatCurrency(estimate.laborTotal);
            document.getElementById('totalCost').textContent = formatCurrency(estimate.total);

            const breakdownContent = document.getElementById('breakdownContent');
            breakdownContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);"><span>Foundation:</span> <strong>${formatCurrency(estimate.costs.foundation)}</strong></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);"><span>Framing:</span> <strong>${formatCurrency(estimate.costs.framing)}</strong></div>
                <div style="display: flex; justify-content: space-between;"><span>Exterior:</span> <strong>${formatCurrency(estimate.costs.exterior)}</strong></div>
            `;

            document.getElementById('breakdownCard').style.display = 'block';
            document.getElementById('estimateSummary').style.display = 'block';
        }

        function saveProject() {
            if (!state.currentEstimate) {
                showToast('No estimate to save.', 'warning');
                return;
            }
            const estimate = { ...state.currentEstimate, estimateType: 'quick', status: state.currentEstimate.status || 'review' };
            if (state.editingProjectId) {
                const idx = state.savedProjects.findIndex(p => p.id === state.editingProjectId);
                if (idx !== -1) {
                    state.savedProjects[idx] = estimate;
                }
                state.editingProjectId = null;
                showToast('Project updated successfully!', 'success');
            } else {
                state.savedProjects.push(estimate);
                showToast('Project saved successfully!', 'success');
            }
            localStorage.setItem('constructionProjects', JSON.stringify(state.savedProjects));
            loadProjects();
            updateDashboard();
        }

        function populateEstimatorForm(data) {
            document.getElementById('projectName').value = data.name || '';
            document.getElementById('projectType').value = data.type || '';
            document.getElementById('sqft').value = data.sqft || '';
            document.getElementById('floors').value = data.floors || '';
            document.getElementById('laborCost').value = data.laborMultiplier || '';

            document.querySelectorAll('[data-foundation]').forEach(c => {
                c.classList.toggle('selected', c.dataset.foundation === data.selected?.foundation);
            });
            document.querySelectorAll('[data-framing]').forEach(c => {
                c.classList.toggle('selected', c.dataset.framing === data.selected?.framing);
            });
            document.querySelectorAll('[data-exterior]').forEach(c => {
                c.classList.toggle('selected', c.dataset.exterior === data.selected?.exterior);
            });
        }

        function editProject(id) {
            const project = state.savedProjects.find(p => p.id === id && p.estimateType === 'quick');
            if (!project) return;
            state.editingProjectId = id;
            state.currentEstimate = { ...project };
            populateEstimatorForm(project);
            displayEstimate(project);
            switchTab('estimator');
        }

        function editBid(id) {
            const bid = state.savedProjects.find(p => p.id === id && p.estimateType === 'detailed');
            if (!bid) return;
            state.editingProjectId = id;
            document.getElementById('bidProjectName').value = bid.name || '';
            document.getElementById('clientName').value = bid.clientName || '';
            document.getElementById('bidDate').value = bid.bidDate || '';
            document.getElementById('completionDays').value = bid.completionDays || '';
            document.getElementById('overhead').value = bid.overheadPercent || 10;
            document.getElementById('profit').value = bid.profitPercent || 15;
            document.getElementById('contingency').value = bid.contingencyPercent || 5;
            document.getElementById('lineItems').innerHTML = '';
            bid.lineItems.forEach(item => addLineItem(item));
            updateBidTotal();
            switchTab('detailed');
        }

        function saveCompanyInfo() {
            state.companyInfo = {
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
            };
            localStorage.setItem('companyInfo', JSON.stringify(state.companyInfo));
            showToast('Company information saved!', 'success');
        }

        // --- DETAILED BIDDING ---
        function addLineItem(item = null) {
            state.lineItemId++;
            const div = document.createElement('div');
            div.className = 'line-item-row';
            div.dataset.id = state.lineItemId;
            
            const categoryOptions = Object.keys(state.lineItemCategories).map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            div.innerHTML = `
                <select class="form-select" data-field="category">${categoryOptions}</select>
                <select class="form-select" data-field="description"></select>
                <input type="number" class="form-input" data-field="quantity" placeholder="Qty" value="${item ? item.quantity : 1}" min="0">
                <input type="text" class="form-input" data-field="unit" placeholder="Unit" value="${item ? item.unit : ''}">
                <input type="number" class="form-input" data-field="rate" placeholder="Rate" value="${item ? item.rate : 0}" step="0.01" min="0">
                <div class="line-item-total" style="font-weight: 600; text-align: right;">${formatCurrency(item ? item.total : 0)}</div>
                <button class="btn btn-ghost remove-line-item">&times;</button>
            `;
            
            document.getElementById('lineItems').appendChild(div);
            updateItemSelectionOptions(div);
        }
        
        function updateItemSelectionOptions(row) {
            const categorySelect = row.querySelector('[data-field="category"]');
            const descriptionSelect = row.querySelector('[data-field="description"]');
            const selectedCategory = categorySelect.value;
            
            const items = state.lineItemCategories[selectedCategory] || [];
            descriptionSelect.innerHTML = items.map(item => `<option value="${item.name}">${item.name}</option>`).join('');
            updateLineItemFromSelection(descriptionSelect);
        }

        function updateLineItemFromSelection(selectElement) {
            const row = selectElement.closest('.line-item-row');
            const category = row.querySelector('[data-field="category"]').value;
            const description = selectElement.value;
            
            const itemData = state.lineItemCategories[category]?.find(i => i.name === description);
            
            if (itemData) {
                row.querySelector('[data-field="unit"]').value = itemData.unit;
                row.querySelector('[data-field="rate"]').value = itemData.rate;
                updateLineItemTotal(row);
            }
        }

        function removeLineItem(row) {
            row.remove();
            updateBidTotal();
        }

        function updateLineItemTotal(row) {
            const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
            const rate = parseFloat(row.querySelector('[data-field="rate"]').value) || 0;
            const total = quantity * rate;
            row.querySelector('.line-item-total').textContent = formatCurrency(total);
            updateBidTotal();
        }

        function updateBidTotal() {
            let subtotal = 0;
            document.querySelectorAll('.line-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
                const rate = parseFloat(row.querySelector('[data-field="rate"]').value) || 0;
                subtotal += quantity * rate;
            });

            const overheadPercent = parseFloat(document.getElementById('overhead').value) || 0;
            const profitPercent = parseFloat(document.getElementById('profit').value) || 0;
            const contingencyPercent = parseFloat(document.getElementById('contingency').value) || 0;
            
            const markup = subtotal * (overheadPercent / 100) + subtotal * (profitPercent / 100);
            const subtotalWithMarkup = subtotal + markup;
            const contingency = subtotalWithMarkup * (contingencyPercent / 100);
            const total = subtotalWithMarkup + contingency;

            document.getElementById('bidSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('bidMarkup').textContent = formatCurrency(markup);
            document.getElementById('bidContingency').textContent = formatCurrency(contingency);
            document.getElementById('bidTotal').textContent = formatCurrency(total);
        }
        
        function saveBid() {
            const name = document.getElementById('bidProjectName').value;
            if (!name) {
                showToast('Project name required', 'warning');
                return;
            }

            const lineItems = [];
            document.querySelectorAll('.line-item-row').forEach(row => {
                const category = row.querySelector('[data-field="category"]').value;
                const description = row.querySelector('[data-field="description"]').value;
                const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
                const unit = row.querySelector('[data-field="unit"]').value;
                const rate = parseFloat(row.querySelector('[data-field="rate"]').value) || 0;
                lineItems.push({ category, description, quantity, unit, rate, total: quantity * rate });
            });

            const overheadPercent = parseFloat(document.getElementById('overhead').value) || 0;
            const profitPercent = parseFloat(document.getElementById('profit').value) || 0;
            const contingencyPercent = parseFloat(document.getElementById('contingency').value) || 0;

            const subtotal = parseFloat(document.getElementById('bidSubtotal').textContent.replace(/[^0-9.-]+/g, '')) || 0;
            const markup = parseFloat(document.getElementById('bidMarkup').textContent.replace(/[^0-9.-]+/g, '')) || 0;
            const contingency = parseFloat(document.getElementById('bidContingency').textContent.replace(/[^0-9.-]+/g, '')) || 0;
            const total = parseFloat(document.getElementById('bidTotal').textContent.replace(/[^0-9.-]+/g, '')) || 0;

            const bid = {
                id: state.editingProjectId || Date.now(),
                estimateType: 'detailed',
                name,
                clientName: document.getElementById('clientName').value,
                bidDate: document.getElementById('bidDate').value,
                completionDays: document.getElementById('completionDays').value,
                lineItems,
                overheadPercent,
                profitPercent,
                contingencyPercent,
                subtotal,
                markup,
                contingency,
                total,
                date: new Date().toISOString(),
                status: state.editingProjectId ? state.savedProjects.find(p => p.id === state.editingProjectId)?.status : 'review'
            };
            if (state.editingProjectId) {
                const idx = state.savedProjects.findIndex(p => p.id === state.editingProjectId);
                if (idx !== -1) {
                    state.savedProjects[idx] = bid;
                }
                state.editingProjectId = null;
                showToast('Bid updated!', 'success');
            } else {
                state.savedProjects.push(bid);
                showToast('Bid saved!', 'success');
            }
            localStorage.setItem('constructionProjects', JSON.stringify(state.savedProjects));
            loadProjects();
            updateDashboard();
        }

        // --- CALCULATOR ---
        function updateCalculatorDisplay() {
            document.getElementById('calculatorDisplay').textContent = state.calculator.displayValue;
        }

        function handleCalculatorClick(e) {
            const { value } = e.target.dataset;
            if (!value) return;

            if (!isNaN(parseFloat(value)) || value === '.') {
                inputDigit(value);
            } else if (value in { '+': 1, '-': 1, '*': 1, '/': 1 }) {
                handleOperator(value);
            } else if (value === '=') {
                handleOperator(value);
            } else if (value === 'clear') {
                resetCalculator();
            } else if (value === 'backspace') {
                state.calculator.displayValue = state.calculator.displayValue.slice(0, -1) || '0';
            } else if (value === '%') {
                state.calculator.displayValue = String(parseFloat(state.calculator.displayValue) / 100);
            } else if (value === "sin") {
                state.calculator.displayValue = String(Math.sin(parseFloat(state.calculator.displayValue)));
            } else if (value === "cos") {
                state.calculator.displayValue = String(Math.cos(parseFloat(state.calculator.displayValue)));
            } else if (value === "tan") {
                state.calculator.displayValue = String(Math.tan(parseFloat(state.calculator.displayValue)));
            } else if (value === "sqrt") {
                state.calculator.displayValue = String(Math.sqrt(parseFloat(state.calculator.displayValue)));
            }
            updateCalculatorDisplay();
        }

        function inputDigit(digit) {
            const { displayValue, waitingForSecondOperand } = state.calculator;
            if (waitingForSecondOperand) {
                state.calculator.displayValue = digit;
                state.calculator.waitingForSecondOperand = false;
            } else {
                state.calculator.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
        }
        
        function handleOperator(nextOperator) {
            const { firstOperand, displayValue, operator } = state.calculator;
            const inputValue = parseFloat(displayValue);

            if (operator && state.calculator.waitingForSecondOperand) {
                state.calculator.operator = nextOperator;
                return;
            }

            if (firstOperand == null && !isNaN(inputValue)) {
                state.calculator.firstOperand = inputValue;
            } else if (operator) {
                const result = calculate(firstOperand, inputValue, operator);
                state.calculator.displayValue = `${parseFloat(result.toFixed(7))}`;
                state.calculator.firstOperand = result;
            }
            
            state.calculator.waitingForSecondOperand = true;
            state.calculator.operator = nextOperator;
        }

        function calculate(first, second, op) {
            if (op === '+') return first + second;
            if (op === '-') return first - second;
            if (op === '*') return first * second;
            if (op === '/') return first / second;
            return second;
        }

        function resetCalculator() {
            state.calculator.displayValue = '0';
            state.calculator.firstOperand = null;
            state.calculator.waitingForSecondOperand = false;
            state.calculator.operator = null;
        }
        
        function handleUnitConversion() {
            const fromUnit = document.getElementById('unitFrom').value;
            const toUnit = document.getElementById('unitTo').value;
            let value = parseFloat(state.calculator.displayValue);
            let result = value;

            const conversions = {
                'ft-in': val => val * 12,
                'in-ft': val => val / 12,
                'sqft-sqyd': val => val / 9,
                'sqyd-sqft': val => val * 9,
            };
            
            const key = `${fromUnit}-${toUnit}`;
            if (conversions[key]) {
                result = conversions[key](value);
            } else {
                showToast('Invalid unit conversion', 'error');
                return;
            }
            
            state.calculator.displayValue = String(parseFloat(result.toFixed(5)));
            updateCalculatorDisplay();
        }
        
        function useCalculatorValue() {
            if (!state.lastFocusedInput) {
                showToast('Select a quantity or rate field first.', 'warning');
                return;
            }
            state.lastFocusedInput.value = state.calculator.displayValue;
            state.lastFocusedInput.dispatchEvent(new Event('input', { bubbles: true }));
            closeModal('calculatorModal');
        }

        // --- REPORTING & EXPORTING ---
function updateCalcMode(mode) {
    state.calcMode = mode;
    document.getElementById("basicTools").style.display = mode === "basic" ? "block" : "none";
    document.getElementById("engineeringBtns").style.display = mode === "engineering" ? "grid" : "none";
    document.getElementById("modeBasic")?.classList.toggle("active", mode === "basic");
    document.getElementById("modeEngineering")?.classList.toggle("active", mode === "engineering");
}

function updateShapeInputs() {
    const shape = document.getElementById("shapeSelect").value;
    const dim2Group = document.getElementById("dim2Group");
    if (shape === "circle") {
        document.getElementById("dim1").placeholder = "Radius";
        dim2Group.style.display = "none";
    } else if (shape === "triangle") {
        document.getElementById("dim1").placeholder = "Base";
        document.getElementById("dim2").placeholder = "Height";
        dim2Group.style.display = "block";
    } else {
        document.getElementById("dim1").placeholder = "Length";
        document.getElementById("dim2").placeholder = "Width";
        dim2Group.style.display = "block";
    }
}

function calculateArea() {
    const shape = document.getElementById("shapeSelect").value;
    const d1 = parseFloat(document.getElementById("dim1").value) || 0;
    const d2 = parseFloat(document.getElementById("dim2").value) || 0;
    let area = 0;
    if (shape === "rectangle") area = d1 * d2;
    else if (shape === "circle") area = Math.PI * d1 * d1;
    else if (shape === "triangle") area = 0.5 * d1 * d2;
    document.getElementById("takeoffResult").textContent = `Area: ${area.toFixed(2)}`;
}

function handlePlanUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        const img = document.getElementById("planPreview");
        img.src = ev.target.result;
        img.style.display = "block";
    };
    reader.readAsDataURL(file);
}
        function getBidDataForExport() {
            const projectName = document.getElementById('bidProjectName').value || 'N/A';
            const clientName = document.getElementById('clientName').value || 'N/A';
            const bidDate = new Date(document.getElementById('bidDate').value).toLocaleDateString();
            
            const data = [
                ['Project Name', projectName],
                ['Client Name', clientName],
                ['Bid Date', bidDate],
                [], // Spacer row
                ['Category', 'Description', 'Quantity', 'Unit', 'Rate', 'Total']
            ];

            let currentCategory = '';
            document.querySelectorAll('.line-item-row').forEach(row => {
                const category = row.querySelector('[data-field="category"]').value;
                if (category !== currentCategory) {
                    currentCategory = category;
                    data.push([category]); // Add category as a full-width row
                }
                const description = row.querySelector('[data-field="description"]').value;
                const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
                const unit = row.querySelector('[data-field="unit"]').value;
                const rate = parseFloat(row.querySelector('[data-field="rate"]').value) || 0;
                const total = quantity * rate;
                data.push(['', description, quantity, unit, rate, total]);
            });
            
            data.push([]); // Spacer row
            
            const subtotal = parseFloat(document.getElementById('bidSubtotal').textContent.replace(/[^0-9.-]+/g,""));
            const markup = parseFloat(document.getElementById('bidMarkup').textContent.replace(/[^0-9.-]+/g,""));
            const contingency = parseFloat(document.getElementById('bidContingency').textContent.replace(/[^0-9.-]+/g,""));
            const total = parseFloat(document.getElementById('bidTotal').textContent.replace(/[^0-9.-]+/g,""));

            data.push(['', '', '', '', 'Subtotal', subtotal]);
            data.push(['', '', '', '', 'Markup', markup]);
            data.push(['', '', '', '', 'Contingency', contingency]);
            data.push(['', '', '', '', 'Total Bid', total]);

            return { data, projectName };
        }

        function exportAsXlsx() {
            const { data, projectName } = getBidDataForExport();
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Bid');
            XLSX.writeFile(workbook, `Bid-${projectName}.xlsx`);
            showToast('Excel file generated!', 'success');
        }

        function exportAsCsv() {
            const { data, projectName } = getBidDataForExport();
            let csvContent = "data:text/csv;charset=utf-8,";
            
            data.forEach(rowArray => {
                let row = rowArray.map(item => `"${String(item).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Bid-${projectName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('CSV file generated!', 'success');
        }

        function exportAsPdf() {
            const projectName = document.getElementById('bidProjectName').value || 'N/A';
            const clientName = document.getElementById('clientName').value || 'N/A';
            const bidDate = new Date(document.getElementById('bidDate').value).toLocaleDateString();
            const completionDays = document.getElementById('completionDays').value || 'N/A';
            const company = state.companyInfo;

            let lineItemsHtml = '';
            let currentCategory = '';
            document.querySelectorAll('.line-item-row').forEach(row => {
                const category = row.querySelector('[data-field="category"]').value;
                if (category !== currentCategory) {
                    currentCategory = category;
                    lineItemsHtml += `<tr><td colspan="5" class="category-row">${currentCategory}</td></tr>`;
                }
                const description = row.querySelector('[data-field="description"]').value;
                const quantity = row.querySelector('[data-field="quantity"]').value;
                const unit = row.querySelector('[data-field="unit"]').value;
                const rate = formatCurrency(parseFloat(row.querySelector('[data-field="rate"]').value) || 0);
                const total = row.querySelector('.line-item-total').textContent;
                lineItemsHtml += `
                    <tr>
                        <td>${description}</td>
                        <td class="text-right">${quantity}</td>
                        <td>${unit}</td>
                        <td class="text-right">${rate}</td>
                        <td class="text-right">${total}</td>
                    </tr>
                `;
            });

            const subtotal = document.getElementById('bidSubtotal').textContent;
            const markup = document.getElementById('bidMarkup').textContent;
            const contingency = document.getElementById('bidContingency').textContent;
            const total = document.getElementById('bidTotal').textContent;

            const reportHtml = `
                <html>
                <head>
                    <title>Bid Report: ${projectName}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 0; padding: 2rem; color: #333; }
                        .header { text-align: center; margin-bottom: 2rem; }
                        .header h1 { margin: 0; color: #4f46e5; }
                        .header p { margin: 0; color: #666; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; background: #f9f9f9; border-radius: 8px; }
                        .info-grid div { display: flex; flex-direction: column; }
                        .info-grid span { font-weight: 600; margin-bottom: 0.25rem; color: #4f46e5; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
                        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
                        th { background: #f1f5f9; font-weight: 600; }
                        .text-right { text-align: right; }
                        .category-row { background: #e0e7ff; font-weight: bold; }
                        .summary { float: right; width: 40%; }
                        .summary-item { display: flex; justify-content: space-between; padding: 0.5rem; }
                        .summary-item.total { font-weight: bold; font-size: 1.2rem; border-top: 2px solid #333; margin-top: 0.5rem; }
                        .print-note { margin-top: 4rem; text-align: center; color: #888; font-style: italic; }
                        @media print { .print-note { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Construction Bid Proposal</h1>
                        <p>${company.name || 'Construction Estimator Pro'}</p>
                        <p>${company.address || ''}</p>
                        <p>${company.phone ? company.phone + ' | ' : ''}${company.email || ''}</p>
                    </div>
                    <div class="info-grid">
                        <div><span>Project Name:</span> ${projectName}</div>
                        <div><span>Client Name:</span> ${clientName}</div>
                        <div><span>Bid Date:</span> ${bidDate}</div>
                        <div><span>Est. Timeline:</span> ${completionDays} days</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>${lineItemsHtml}</tbody>
                    </table>
                    <div class="summary">
                        <div class="summary-item"><span>Subtotal:</span> <span>${subtotal}</span></div>
                        <div class="summary-item"><span>Markup (Overhead & Profit):</span> <span>${markup}</span></div>
                        <div class="summary-item"><span>Contingency:</span> <span>${contingency}</span></div>
                        <div class="summary-item total"><span>Total Bid Price:</span> <span>${total}</span></div>
                    </div>
                    <div class="print-note">
                        <p>To save, use your browser's print function (Ctrl+P or Cmd+P) and select "Save as PDF".</p>
                    </div>
                </body>
                </html>
            `;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHtml);
            reportWindow.document.close();
            showToast('PDF report generated in new tab.', 'success');
        }

        // --- PROJECTS & MATERIALS ---
        function loadProjects(searchTerm = '') {
            const list = document.getElementById('projectsList');
            list.innerHTML = '';
            
            const filteredProjects = state.savedProjects.filter(p =>
                p.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredProjects.length === 0) {
                list.innerHTML = `<p style="color: var(--gray-600);">No saved projects found.</p>`;
                return;
            }

            filteredProjects.forEach(p => {
                const div = document.createElement('div');
                div.style = "padding: 1rem; background: var(--gray-100); border-radius: 12px; margin-bottom: 1rem;";
                const typeLabel = p.estimateType === 'detailed' ? 'Detailed' : 'Quick';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="font-weight: 600;">${p.name}</h4>
                            <p style="color: var(--gray-600); font-size: 0.875rem;">${p.type || ''}${p.sqft ? ' • ' + p.sqft + ' sqft' : ''} • ${typeLabel}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-weight: 700; color: var(--primary);">${formatCurrency(p.total)}</p>
                            <p style="color: var(--gray-600); font-size: 0.75rem;">${new Date(p.date).toLocaleDateString()}</p>
                            <select class="form-select project-status" data-id="${p.id}" style="margin-top:0.25rem;">
                                <option value="review" ${p.status === 'review' ? 'selected' : ''}>Under Review</option>
                                <option value="won" ${p.status === 'won' ? 'selected' : ''}>Won</option>
                                <option value="lost" ${p.status === 'lost' ? 'selected' : ''}>Lost</option>
                            </select>
                            <button class="btn btn-secondary ${p.estimateType === 'quick' ? 'edit-project' : 'edit-bid'}" data-id="${p.id}" style="margin-top:0.25rem;">Edit</button>
                        </div>
                    </div>
                `;
                const statusSelect = div.querySelector('.project-status');
                statusSelect.addEventListener('change', (e) => updateProjectStatus(p.id, e.target.value));
                div.querySelector('.edit-project')?.addEventListener('click', () => editProject(p.id));
                div.querySelector('.edit-bid')?.addEventListener('click', () => editBid(p.id));
                list.appendChild(div);
            });
        }

        function updateProjectStatus(id, status) {
            const proj = state.savedProjects.find(p => p.id === id);
            if (!proj) return;
            proj.status = status;
            localStorage.setItem('constructionProjects', JSON.stringify(state.savedProjects));
            updateDashboard();
        }

        function exportProjects() {
            const data = JSON.stringify(state.savedProjects);
            const blob = new Blob([data], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'projects.json';
            link.click();
        }

        function importProjects(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const projects = JSON.parse(reader.result);
                    if (Array.isArray(projects)) {
                        state.savedProjects = projects;
                        localStorage.setItem('constructionProjects', JSON.stringify(projects));
                        loadProjects();
                        updateDashboard();
                        showToast('Projects imported!', 'success');
                    }
                } catch (err) {
                    showToast('Invalid project file.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function updateDashboard() {
            const totalProjectsEl = document.getElementById('totalProjects');
            const totalValueEl = document.getElementById('totalValue');
            const reviewEl = document.getElementById('reviewCount');
            const winRateEl = document.getElementById('winRate');
            const recentList = document.getElementById('recentProjectsList');

            const totalProjects = state.savedProjects.length;
            const totalValue = state.savedProjects.reduce((sum, p) => sum + (p.total || 0), 0);
            const review = state.savedProjects.filter(p => p.status === 'review').length;
            const wins = state.savedProjects.filter(p => p.status === 'won').length;
            const totalConsidered = state.savedProjects.filter(p => p.status !== 'review').length;
            const winRate = totalConsidered ? Math.round((wins / totalConsidered) * 100) : 0;

            if (totalProjectsEl) totalProjectsEl.textContent = totalProjects;
            if (totalValueEl) totalValueEl.textContent = formatCurrency(totalValue);
            if (reviewEl) reviewEl.textContent = review;
            if (winRateEl) winRateEl.textContent = winRate + '%';

            if (!recentList) return;
            recentList.innerHTML = '';
            const recent = state.savedProjects.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,3);
            if (recent.length === 0) {
                recentList.innerHTML = `<p style="color: var(--gray-600);">No saved projects.</p>`;
                return;
            }
            recent.forEach(p => {
                const div = document.createElement('div');
                div.style = "padding: 1rem; background: var(--gray-100); border-radius: 12px; margin-bottom: 1rem; cursor:pointer;";
                const typeLabel = p.estimateType === 'detailed' ? 'Detailed' : 'Quick';
                div.innerHTML = `
                    <div style="display:flex; justify-content: space-between; align-items:center;">
                        <div>
                            <h4 style="font-weight:600;">${p.name}</h4>
                            <p style="color: var(--gray-600); font-size:0.875rem;">${p.type || ''}${p.sqft ? ' • ' + p.sqft + ' sqft' : ''} • ${typeLabel}</p>
                        </div>
                        <div style="text-align:right;">
                            <p style="font-weight:700; color: var(--primary);">${formatCurrency(p.total)}</p>
                            <p style="color: var(--gray-600); font-size:0.75rem;">${new Date(p.date).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                div.addEventListener('click', () => {
                    if (p.estimateType === 'quick') {
                        editProject(p.id);
                    } else {
                        switchTab('projects');
                    }
                });
                recentList.appendChild(div);
            });
        }

        function populateMaterialsTable() {
            const tableBody = document.getElementById('materialsTable');
            tableBody.innerHTML = '';
            Object.entries(state.materialPrices).forEach(([category, materials]) => {
                Object.entries(materials).forEach(([name, price]) => {
                    const row = tableBody.insertRow();
                    const trend = Math.random() > 0.5 ? '▲' : '▼';
                    const trendColor = trend === '▲' ? 'var(--danger)' : 'var(--success)';
                    row.innerHTML = `
                        <td>${name.charAt(0).toUpperCase() + name.slice(1)}</td>
                        <td>${category.charAt(0).toUpperCase() + category.slice(1)}</td>
                        <td>${formatCurrency(price)}</td>
                        <td>sqft</td>
                        <td style="color: ${trendColor}; font-weight: bold;">${trend} ${(Math.random() * 5).toFixed(1)}%</td>
                    `;
                });
            });
        }

        // --- CHARTS ---
        function initCharts() {
            const ctxPrice = document.getElementById('priceChart')?.getContext('2d');
            if (ctxPrice) new Chart(ctxPrice, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [
                        { label: 'Lumber', data: [12, 19, 13, 15, 12, 13], borderColor: 'rgba(99, 102, 241, 1)', tension: 0.4, fill: false },
                        { label: 'Steel', data: [20, 22, 21, 24, 25, 23], borderColor: 'rgba(16, 185, 129, 1)', tension: 0.4, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

        }

        // --- SETTINGS & UPDATES ---
        function checkForUpdatesOnLoad() {
            setTimeout(() => {
                openModal('updateModal');
            }, 3000);
        }
        
        function checkForUpdates() {
            const syncBadge = document.getElementById('syncStatus');
            syncBadge.classList.add('syncing');
            syncBadge.querySelector('span').textContent = 'Checking...';
            
            setTimeout(() => {
                syncBadge.classList.remove('syncing');
                openModal('updateModal');
            }, 2000);
        }

        function applyUpdate() {
            const syncBadge = document.getElementById('syncStatus');
            syncBadge.classList.add('syncing');
            syncBadge.querySelector('span').textContent = 'Updating...';
            
            setTimeout(() => {
                state.materialPrices.framing.wood *= 0.95;
                state.materialPrices.framing.steel *= 1.03;
                
                closeModal('updateModal');
                populateMaterialsTable();
                
                syncBadge.classList.remove('syncing');
                syncBadge.classList.add('success');
                syncBadge.querySelector('span').textContent = 'Database Synced';
                
                showToast('Material database updated!', 'success');
                
                setTimeout(() => syncBadge.classList.remove('success'), 3000);
            }, 2500);
        }
        
        // --- RUN APP ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDatabase();
            init();
        });

    })();
    </script>
</body>
</html>
